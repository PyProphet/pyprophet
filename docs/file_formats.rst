.. _file_formats:

File Formats
=========================

Feature Files
-------------

The input files for PyProphet are typically feature files generated by `OpenSWATH <http://openswath.org/en/latest/docs/openswath.html>`_. These files contain the precursor peak-group features extracted from the raw data, which are then used for scoring and analysis in PyProphet. As of OpenSWATH v2.4.0, the feature files are stored in the OpenSWATH SQLite format (*.osw*), but also supports tabular (*.tsv*) output and markup XML (*.featureXML*) output. 
Recent updates to PyProphet (v3.0.0) supports converting the SQLite (*.osw*) format to Parquet format, which is a columnar storage file format that is optimized for use with large datasets.

OpenSWATH SQLite Format (*.osw*)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

The OSW-sqlite based files have a flexible relational data structure. They contain all peptide query parameters of `PQP files <https://openms.de/documentation/classOpenMS_1_1TransitionPQPFile.html>`_ with the detected and quantified features of OpenSwathWorkflow (feature, feature_ms1, feature_ms2 & feature_transition). You can find more information on the feature tables and the schema from OpenMS's documentation on `OpenSWATH SQLite <https://openms.de/documentation/classOpenMS_1_1OpenSwathOSWWriter.html>`_.

Parquet Format (*.parquet*)
^^^^^^^^^^^^^^^^^^^^^^^^^^^
.. _parquet_format:

Parquet is a columnar storage file format that is optimized for use with large datasets. It is designed to be efficient in terms of both storage space and query performance. PyProphet supports reading and writing Parquet files, allowing users to work with large datasets more efficiently. PyProphet offers the options to convert the OpenSWATH SQLite format (*.osw*) to a single parquet file (with both precursor and transition data). The data is stored in two separate blocks to separate precursor and transition data, similar to the example table below:

+------------+------------+----------------+--------------+-------------------------------+--------+------+------------+--------------------+---------------------+--------------------+---------------+-----------------------+--------------------+---------------------+--------------------+-----------------+------------------+
| protein_id | peptide_id | ipf_peptide_id | precursor_id |       modified_sequence       | charge |  RT  | feature_id | prec_feat_var_1    | prec_feat_var_2     | prec_feat_var_3    | transition_id | transition_annotation | transition_feat_1  | transition_feat_2   | transition_feat_3  | precursor_score | transition_score |
+============+============+================+==============+===============================+========+======+============+====================+=====================+====================+===============+=======================+====================+=====================+====================+=================+==================+
| 1556       | 8044       | 8044           | 0            | .(UniMod:26)CDTDVPFQLK        | 2      | 786  | 4564656    | 0.8251878619194031 | 0.9905699491500854  | 0.9867947697639465 | NULL          | NULL                  | NULL               | NULL                | NULL               | 98              | NULL             |
+------------+------------+----------------+--------------+-------------------------------+--------+------+------------+--------------------+---------------------+--------------------+---------------+-----------------------+--------------------+---------------------+--------------------+-----------------+------------------+
| 0          | 13404      | 13404          | 21408        | .(UniMod:26)CDVVYTHGLQDWNVKPR | 3      | 547  | 2341534    | 0.7650477886199951 | 0.9925554990768433  | 0.6403021812438965 | NULL          | NULL                  | NULL               | NULL                | NULL               | 79              | NULL             |
+------------+------------+----------------+--------------+-------------------------------+--------+------+------------+--------------------+---------------------+--------------------+---------------+-----------------------+--------------------+---------------------+--------------------+-----------------+------------------+
| 1634       | 0          | 0              | 16886        | FSWISTGGGASMELLEGK            | 2      | 234  | 65687785   | 0.7152583599090576 | 0.812627375125885   | 0.6165676116943359 | NULL          | NULL                  | NULL               | NULL                | NULL               | 56              | NULL             |
+------------+------------+----------------+--------------+-------------------------------+--------+------+------------+--------------------+---------------------+--------------------+---------------+-----------------------+--------------------+---------------------+--------------------+-----------------+------------------+
| 3455       | 6788       | 6788           | 3659         | ENADLIMVGATGLNTFER            | 3      | 453  | 13245346   | 0.8531889319419861 | 0.15485289692878723 | 0.5889896154403687 | NULL          | NULL                  | NULL               | NULL                | NULL               | 32              | NULL             |
+------------+------------+----------------+--------------+-------------------------------+--------+------+------------+--------------------+---------------------+--------------------+---------------+-----------------------+--------------------+---------------------+--------------------+-----------------+------------------+
| NULL       | NULL       | 8044           | 0            | NULL                          | NULL   | NULL | 4564656    | NULL               | NULL                | NULL               | 0             | y7                    | 6.691071510314941  | 0.46852633357048035 | 0.6704034209251404 | NULL            | 98               |
+------------+------------+----------------+--------------+-------------------------------+--------+------+------------+--------------------+---------------------+--------------------+---------------+-----------------------+--------------------+---------------------+--------------------+-----------------+------------------+
| NULL       | NULL       | 8044           | 0            | NULL                          | NULL   | NULL | 4564656    | NULL               | NULL                | NULL               | 2             | b7                    | 4.816525459289551  | 0.3565627932548523  | 0.5738980174064636 | NULL            | 86               |
+------------+------------+----------------+--------------+-------------------------------+--------+------+------------+--------------------+---------------------+--------------------+---------------+-----------------------+--------------------+---------------------+--------------------+-----------------+------------------+
| NULL       | NULL       | 8044           | 0            | NULL                          | NULL   | NULL | 4564656    | NULL               | NULL                | NULL               | 18            | y3                    | 2.7247447967529297 | 0.6799249053001404  | 0.7191503047943115 | NULL            | 67               |
+------------+------------+----------------+--------------+-------------------------------+--------+------+------------+--------------------+---------------------+--------------------+---------------+-----------------------+--------------------+---------------------+--------------------+-----------------+------------------+
| NULL       | NULL       | 13404          | 21408        | NULL                          | NULL   | NULL | 2341534    | NULL               | NULL                | NULL               | 45            | y5                    | 4.299717426300049  | 0.45827046036720276 | 0.6673739552497864 | NULL            | 45               |
+------------+------------+----------------+--------------+-------------------------------+--------+------+------------+--------------------+---------------------+--------------------+---------------+-----------------------+--------------------+---------------------+--------------------+-----------------+------------------+
| NULL       | NULL       | 13404          | 21408        | NULL                          | NULL   | NULL | 2341534    | NULL               | NULL                | NULL               | 98            | b3                    | 4.548809051513672  | 0.7069618105888367  | 0.7448312044143677 | NULL            | 34               |
+------------+------------+----------------+--------------+-------------------------------+--------+------+------------+--------------------+---------------------+--------------------+---------------+-----------------------+--------------------+---------------------+--------------------+-----------------+------------------+

Split Parquet Format (*.parquet* / *.oswpq* / *.oswpqd*)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.. _split_parquet_format:

PyProphet also supports a split parquet format, which is useful for large datasets. This format splits the precursor and transition data into separate files, allowing for more efficient storage and processing. The split parquet format can be used with the `--split_transition_data` option when converting from OpenSWATH SQLite format to Parquet format. The split parquet files are named as follows:

.. code-block:: text

    â””â”€â”€ ğŸ“ merged_runs.oswpq
        â”œâ”€â”€ ğŸ“„ precursors_features.parquet
        â””â”€â”€ ğŸ“„ transition_features.parquet


To further split the data by run, you can use the `--split_runs` option. This will create separate parquet files for each run, which can be useful for large datasets with multiple runs. The split parquet files are named as follows:

.. code-block:: text

    â””â”€â”€ ğŸ“ merged_runs.oswpqd
        â”œâ”€â”€ ğŸ“ 20200626_erli_phos_10.oswpq
        â”‚   â”œâ”€â”€ ğŸ“„ precursors_features.parquet
        â”‚   â””â”€â”€ ğŸ“„ transition_features.parquet
        â”œâ”€â”€ ğŸ“ 20200626_erli_phos_101.oswpq
        â”‚   â”œâ”€â”€ ğŸ“„ precursors_features.parquet
        â”‚   â””â”€â”€ ğŸ“„ transition_features.parquet
        â”œâ”€â”€ ğŸ“ 20200626_erli_phos_102.oswpq
        â”‚   â”œâ”€â”€ ğŸ“„ precursors_features.parquet
        â”‚   â””â”€â”€ ğŸ“„ transition_features.parquet
        â”œâ”€â”€ ğŸ“ 20200626_erli_phos_103.oswpq
        â”‚   â”œâ”€â”€ ğŸ“„ precursors_features.parquet
        â”‚   â””â”€â”€ ğŸ“„ transition_features.parquet
        â”œâ”€â”€ ğŸ“ 20200626_erli_phos_104.oswpq
        â”‚   â”œâ”€â”€ ğŸ“„ precursors_features.parquet
        â”‚   â””â”€â”€ ğŸ“„ transition_features.parquet
        â”œâ”€â”€ ğŸ“ 20200626_erli_phos_105.oswpq
        â”‚   â”œâ”€â”€ ğŸ“„ precursors_features.parquet
        â”‚   â””â”€â”€ ğŸ“„ transition_features.parquet
        â”œâ”€â”€ ğŸ“ 20200626_erli_phos_106.oswpq
        â”‚   â”œâ”€â”€ ğŸ“„ precursors_features.parquet
        â”‚   â””â”€â”€ ğŸ“„ transition_features.parquet
        â”œâ”€â”€ ğŸ“ 20200626_erli_phos_107.oswpq
        â”‚   â”œâ”€â”€ ğŸ“„ precursors_features.parquet
        â”‚   â””â”€â”€ ğŸ“„ transition_features.parquet
        â”œâ”€â”€ ğŸ“ 20200626_erli_phos_108.oswpq
        â”‚   â”œâ”€â”€ ğŸ“„ precursors_features.parquet
        â”‚   â””â”€â”€ ğŸ“„ transition_features.parquet
        â”œâ”€â”€ ğŸ“ 20200626_erli_phos_109.oswpq
        â”‚   â”œâ”€â”€ ğŸ“„ precursors_features.parquet
        â”‚   â””â”€â”€ ğŸ“„ transition_features.parquet
        â”‚   ... (236 more run(s) collapsed)


Extracted Ion Chromatograms (XICs)
----------------------------------

OpenSwathWorkflow allows for the optional output of extracted ion chromatograms (XICs) for each precursor and transition. These XICs are stored in the OpenSWATH SQLite format (*.sqMass*). The XICs can be used for further analysis (chromatogram feature alignment using `DIAlignR <https://github.com/shubham1637/DIAlignR>`_ or `ARYCAL <https://github.com/singjc/arycal>`_) or visualization of the data (using `massdash <https://github.com/Roestlab/massdash>`_). 

SqMass Format (*.sqMass*)
^^^^^^^^^^^^^^^^^^^^^^^^^

You can find more information on the sqMass format and the schema from OpenMS's documentation on `SqMass File <https://openms.de/documentation/classOpenMS_1_1SqMassFile.html>`_.

Parquet Format (*.parquet*)
^^^^^^^^^^^^^^^^^^^^^^^^^^^

PyProphet supports converting the OpenSWATH SQLite format (*.sqMass*) to a parquet format, for better storage. You can use the :program:`export parquet` subcommand to convert the OpenSWATH SQLite format (*.sqMass*) to a parquet format. 